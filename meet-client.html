<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Videochat Meet</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f1f3f4;
    }
    #video-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .video-wrapper {
      position: relative;
      background: #202124;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 1px 2px rgba(0,0,0,0.3);
    }
    .video-wrapper video {
      width: 100%;
      display: block;
    }
    .video-wrapper .user-name {
      position: absolute;
      bottom: 0;
      left: 0;
      background: rgba(0,0,0,0.5);
      color: white;
      padding: 5px 10px;
      font-size: 14px;
    }
    #local-video {
      transform: scaleX(-1); /* Espelha a câmera local */
    }
    #controls {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 15px;
      background: white;
      padding: 10px 20px;
      border-radius: 50px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    .control-btn {
      background: #f1f3f4;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .control-btn:hover {
      background: #e0e0e0;
    }
    .control-btn.end-call {
      background: #ea4335;
      color: white;
    }
    .control-btn.end-call:hover {
      background: #d33426;
    }
    .control-btn.muted {
      background: #ea4335;
      color: white;
    }
  </style>
</head>
<body>
  <h1>Videochat Meet</h1>
  <div id="video-container">
    <div class="video-wrapper" id="local-video-wrapper">
      <video id="local-video" autoplay muted playsinline></video>
      <div class="user-name">Você</div>
    </div>
  </div>

  <div id="controls">
    <button class="control-btn" id="mic-btn" title="Microfone">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
        <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"></path>
        <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"></path>
      </svg>
    </button>
    <button class="control-btn" id="camera-btn" title="Câmera">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
        <path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm-7 7H3v4c0 1.1.9 2 2 2h4v-2H5v-4zM5 5h4V3H5c-1.1 0-2 .9-2 2v4h2V5zm14-2h-4v2h4v4h2V5c0-1.1-.9-2-2-2zm0 16h-4v2h4c1.1 0 2-.9 2-2v-4h-2v4z"></path>
      </svg>
    </button>
    <button class="control-btn end-call" id="end-call-btn" title="Sair da chamada">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
        <path d="M18.59 12.23c.67.38 1.3.8 1.88 1.27l1.07-1.07c-.92-.75-1.91-1.39-2.96-1.91v1.71zM3.53 13.64c.93.64 1.93 1.23 2.98 1.73v-1.71c-.66-.35-1.29-.72-1.87-1.13l-1.11 1.11zM16.19 14.42c.39-.53.76-1.07 1.08-1.65l-1.59-1.07c-.32.6-.67 1.14-1.06 1.62v1.1zM7.6 15.31v-1.1c-.39-.47-.74-1.02-1.06-1.62L5 13.77c.32.58.69 1.12 1.08 1.65l1.52-1.11zM15 12h2c0-2.76-2.24-5-5-5v1.5c1.93 0 3.5 1.57 3.5 3.5zm3 0h2c0-4.97-4.03-9-9-9v1.5c4.14 0 7.5 3.36 7.5 7.5z"></path>
      </svg>
    </button>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const videoContainer = document.getElementById('video-container');
    const localVideo = document.getElementById('local-video');
    const peers = {};
    let localStream;

    // Controles
    const micBtn = document.getElementById('mic-btn');
    const cameraBtn = document.getElementById('camera-btn');
    const endCallBtn = document.getElementById('end-call-btn');

    // Iniciar mídia local
    async function startLocalMedia() {
      try {
        localStream = await navigator.mediaDevices.getUserMedia({
          video: true,
          audio: true
        });
        localVideo.srcObject = localStream;

        // Configurar controles
        micBtn.addEventListener('click', toggleMic);
        cameraBtn.addEventListener('click', toggleCamera);
        endCallBtn.addEventListener('click', endCall);
      } catch (err) {
        console.error('Erro ao acessar mídia:', err);
        alert('Não foi possível acessar a câmera/microfone. Por favor, verifique suas permissões.');
      }
    }

    // Alternar microfone
    function toggleMic() {
      const audioTracks = localStream.getAudioTracks();
      audioTracks.forEach(track => {
        track.enabled = !track.enabled;
      });
      micBtn.classList.toggle('muted', !audioTracks[0].enabled);
    }

    // Alternar câmera
    function toggleCamera() {
      const videoTracks = localStream.getVideoTracks();
      videoTracks.forEach(track => {
        track.enabled = !track.enabled;
      });
      cameraBtn.classList.toggle('muted', !videoTracks[0].enabled);
    }

    // Encerrar chamada
    function endCall() {
      // Fechar todas as conexões
      Object.values(peers).forEach(peer => peer.close());
      
      // Parar streams locais
      if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
      }
      
      // Redirecionar ou mostrar mensagem
      window.location.href = '/';
    }

    // Criar conexão peer com outro usuário
    async function createPeerConnection(userId) {
      if (peers[userId]) return;

      console.log(`Criando conexão peer com ${userId}`);
      
      const peerConnection = new RTCPeerConnection({
        iceServers: [
          { urls: 'stun:stun.l.google.com:19302' },
          // Você pode adicionar servidores TURN aqui para NATs mais restritivos
        ]
      });

      peers[userId] = peerConnection;

      // Adicionar stream local à conexão
      localStream.getTracks().forEach(track => {
        peerConnection.addTrack(track, localStream);
      });

      // Criar elemento de vídeo remoto
      const remoteVideoWrapper = document.createElement('div');
      remoteVideoWrapper.className = 'video-wrapper';
      remoteVideoWrapper.id = `remote-${userId}`;
      
      const remoteVideo = document.createElement('video');
      remoteVideo.id = `video-${userId}`;
      remoteVideo.autoplay = true;
      remoteVideo.playsInline = true;
      
      const userName = document.createElement('div');
      userName.className = 'user-name';
      userName.textContent = `Usuário ${userId.slice(0, 5)}`;
      
      remoteVideoWrapper.appendChild(remoteVideo);
      remoteVideoWrapper.appendChild(userName);
      videoContainer.appendChild(remoteVideoWrapper);

      // Lidar com candidatos ICE
      peerConnection.onicecandidate = (event) => {
        if (event.candidate) {
          console.log(`Enviando ICE candidate para ${userId}`);
          socket.emit('signal', {
            type: 'ice-candidate',
            target: userId,
            candidate: event.candidate
          });
        }
      };

      // Lidar com stream remoto
      peerConnection.ontrack = (event) => {
        console.log(`Recebendo stream de ${userId}`);
        const remoteVideo = document.getElementById(`video-${userId}`);
        if (remoteVideo && !remoteVideo.srcObject) {
          remoteVideo.srcObject = event.streams[0];
        }
      };

      // Criar oferta imediatamente
      try {
        console.log(`Criando oferta para ${userId}`);
        const offer = await peerConnection.createOffer({
          offerToReceiveAudio: true,
          offerToReceiveVideo: true
        });
        await peerConnection.setLocalDescription(offer);
        
        socket.emit('signal', {
          type: 'offer',
          target: userId,
          offer: offer
        });
      } catch (err) {
        console.error('Erro ao criar oferta:', err);
      }
    }

    // Lidar com usuários existentes
    socket.on('existing-users', (userIds) => {
      console.log('Usuários existentes:', userIds);
      userIds.forEach(userId => {
        createPeerConnection(userId);
      });
    });

    // Lidar com novo usuário conectado
    socket.on('user-connected', (userId) => {
      console.log(`Novo usuário conectado: ${userId}`);
      createPeerConnection(userId);
    });

    // Lidar com mensagens de sinalização
    socket.on('signal', async (data) => {
      console.log(`Recebido sinal de ${data.sender}:`, data.type);
      
      // Se não temos uma conexão com este usuário, criamos uma
      if (!peers[data.sender]) {
        await createPeerConnection(data.sender);
      }

      const peerConnection = peers[data.sender];
      if (!peerConnection) return;

      try {
        switch (data.type) {
          case 'offer':
            console.log('Processando oferta de', data.sender);
            await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            
            socket.emit('signal', {
              type: 'answer',
              target: data.sender,
              answer: answer
            });
            break;
            
          case 'answer':
            console.log('Processando resposta de', data.sender);
            await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
            break;
            
          case 'ice-candidate':
            console.log('Adicionando ICE candidate de', data.sender);
            try {
              await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
            } catch (e) {
              console.error('Erro ao adicionar ICE candidate:', e);
            }
            break;
        }
      } catch (err) {
        console.error('Erro no processo de sinalização:', err);
      }
    });

    // Lidar com usuário desconectado
    socket.on('user-disconnected', (userId) => {
      console.log(`Usuário desconectado: ${userId}`);
      if (peers[userId]) {
        peers[userId].close();
        delete peers[userId];
        
        const remoteVideo = document.getElementById(`remote-${userId}`);
        if (remoteVideo) remoteVideo.remove();
      }
    });

    // Iniciar aplicação
    startLocalMedia();

    // Log de eventos de conexão do socket
    socket.on('connect', () => {
      console.log('Conectado ao servidor Socket.IO');
    });

    socket.on('disconnect', () => {
      console.log('Desconectado do servidor Socket.IO');
    });
  </script>
</body>
</html>